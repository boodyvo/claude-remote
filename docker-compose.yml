version: '3.8'

services:
  # ==================================================
  # Telegram Bot Service - Voice Control Interface
  # ==================================================
  telegram-bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: telegram-bot
    working_dir: /app

    # Environment variables (injected by Coolify or .env file)
    # NOTE: ANTHROPIC_API_KEY is NOT needed - using Claude subscription via 'claude login'
    environment:
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:?TELEGRAM_TOKEN is required}
      - DEEPGRAM_API_KEY=${DEEPGRAM_API_KEY:?DEEPGRAM_API_KEY is required}
      - WEBHOOK_URL=${WEBHOOK_URL:-}
      - ALLOWED_USER_IDS=${ALLOWED_USER_IDS:-}
      - BOT_MODE=${BOT_MODE:-polling}
      - SESSIONS_DIR=${SESSIONS_DIR:-./sessions}
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

    volumes:
      # Explicit bind mounts - Coolify won't rename these if host paths exist
      - type: bind
        source: /data/claude-remote/sessions
        target: /app/sessions
        is_directory: true
      - type: bind
        source: /data/claude-remote/claude-home
        target: /home/botuser
        is_directory: true

    # Health check for monitoring
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import sys; sys.exit(0)' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

    networks:
      - claude-network

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================================================
  # File Browser - Web-based File Manager
  # ==================================================
  file-browser:
    image: filebrowser/filebrowser:s6
    container_name: file-browser

    environment:
      - PUID=0        # Run as root to match workspace permissions
      - PGID=0
      - FB_NOAUTH=false
      - FB_DATABASE=/database/filebrowser.db
      - FB_ROOT=/srv
      - FB_LOG=stdout

    volumes:
      - type: bind
        source: /data/claude-remote/claude-home
        target: /srv
        read_only: true
        is_directory: true
      - type: bind
        source: /data/claude-remote/filebrowser
        target: /database
        is_directory: true
      - ./filebrowser-config.json:/.filebrowser.json:ro

    # Port exposure removed for Coolify deployment
    # Coolify's Traefik proxy handles routing via domain configuration
    # For local testing: docker-compose -f docker-compose.yml -f docker-compose.local.yml up

    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:80/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    restart: unless-stopped

    networks:
      - claude-network

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ==================================================
# Networks - Service Communication
# ==================================================
networks:
  # Internal network for service communication
  claude-network:
    driver: bridge
